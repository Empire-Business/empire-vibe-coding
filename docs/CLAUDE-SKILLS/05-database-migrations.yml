name: "db-migration"
description: "Gera migrations seguras para Supabase com validação e RLS policies"
parameters:
  - name: "operation"
    description: "Tipo de operação no banco"
    required: true
    type: "string"
    enum: ["add-table", "add-column", "add-rls", "migration", "seed", "index", "function"]
  - name: "tableName"
    description: "Nome da tabela afetada"
    required: false
    type: "string"
  - name: "description"
    description: "Descrição clara do que a migration faz"
    required: true
    type: "string"
  - name: "columns"
    description: "Definição de colunas (para create table)"
    required: false
    type: "array"
  - name: "rlsPolicies"
    description: "Políticas RLS a serem aplicadas"
    required: false
    type: "array"
  - name: "cascadeDelete"
    description: "Usar ON DELETE CASCADE"
    required: false
    type: "boolean"
    default: false
  - name: "reversible"
    description: "Gerar migração reversível (com DOWN)"
    required: false
    type: "boolean"
    default: true

steps:
  - name: "validate_params"
    description: "Valida parâmetros da migration"

  - name: "generate_ddl"
    description: "Gera SQL DDL para a operação"

  - name: "add_rls"
    description: "Adiciona RLS policies se solicitado"

  - name: "add_indexes"
    description: "Adiciona índices para performance"

  - name: "generate_down"
    description: "Gera migração reversível (DOWN)"

  - name: "validate_migration"
    description: "Valida SQL gerado"

examples:
  - operation: "add-table"
    tableName: "user_preferences"
    description: "Create user preferences table"
    columns:
      - name: "user_id"
        type: "uuid"
        references: "auth.users(id)"
        primary: true
      - name: "theme"
        type: "text"
        default: "'light'"
      - name: "language"
        type: "text"
        default: "'pt-BR'"
    rlsPolicies:
      - operation: "select"
        condition: "auth.uid() = user_id"
      - operation: "update"
        condition: "auth.uid() = user_id"

output_format: |
  ```sql
  -- Migration: [descricao]
  -- Created: [YYYY-MM-DD]
  -- Author: Claude Code
  -- Description: [descricao detalhada]

  -- ========== UP ==========

  CREATE TABLE IF NOT EXISTS public.[table_name] (
    -- Colunas
    [columns_definition]

    -- Timestamps
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
  );

  -- Enable RLS
  ALTER TABLE public.[table_name] ENABLE ROW LEVEL SECURITY;

  -- Policies
  [rls_policies]

  -- Indexes
  CREATE INDEX IF NOT EXISTS idx_[table_name]_[column] ON public.[table_name]([column]);

  -- Trigger para updated_at
  CREATE TRIGGER set_[table_name]_updated_at
    BEFORE UPDATE ON public.[table_name]
    FOR EACH ROW
    EXECUTE FUNCTION update_modified_column();

  -- ========== DOWN ==========

  DROP TRIGGER IF EXISTS set_[table_name]_updated_at ON public.[table_name];
  DROP INDEX IF EXISTS idx_[table_name]_[column];
  DROP POLICY IF EXISTS [policy_name] ON public.[table_name];
  ALTER TABLE public.[table_name] DROP CONSTRAINT IF EXISTS [fk_constraint];
  DROP TABLE IF EXISTS public.[table_name];
  ```

  ### Notas de Segurança

  - Todas as tabelas terão RLS habilitado
  - Policies seguem princípio de menor privilégio
  - Soft delete via `deleted_at` quando aplicável
  - Timestamps automáticos em created_at/updated_at

patterns:
  table_naming:
    - "snake_case plural: user_profiles, order_items"
    - "uuid PK com REFERENCES auth.users(id)"
    - "created_at/updated_at TIMESTAMPTZ DEFAULT NOW()"

  rls_templates:
    - "Owner: auth.uid() = id"
    - "Organization: org_id = current_org_id()"
    - "Public: true (para dados públicos)"
    - "Admin: auth.role() = 'admin'"

safety_rules:
  - "CREATE TABLE IF NOT EXISTS"
  - "DROP TABLE IF EXISTS CASCADE"
  - "DROP POLICY IF EXISTS"
  - "Usar transactions para múltiplas operações"
  - "Testar DOWN migration"
